{% extends 'base.html' %}
{% load static %}
{% block title %} Payroll Manager | Payroll Generation | QuickPay {% endblock %}
{% block content %}

<div class="container mt-4">
    <h2 class="text-primary mb-4">Generate Payroll for <strong>{{ employee.user.username }}</strong></h2>

    <div class="row">

        <!-- Left: Payroll Form -->
        <div class="col-md-5">
            <div class="card shadow-sm p-4">
                <form method="POST" id="payroll-form">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label fw-bold">Basic Pay</label>
                        <input type="text" class="form-control" value="{{ employee.salary }}" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Performance Bonus</label>
                        <input type="text" class="form-control" value="{{ performance_bonus }}" readonly>
                        <small class="text-muted">Taken from latest performance review.</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Other Allowances</label>
                        {{ form.other_allowances }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tax Amount</label>
                        {{ form.tax_amt }}
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        Generate Payroll
                    </button>
                </form>
            </div>
        </div>

        <!-- Right: Preview -->
        <div class="col-md-6 offset-md-1">
            <div class="card shadow-sm p-4">
                <h4 class="text-success mb-3">Live Payroll Preview</h4>

                <table class="table table-bordered text-center">
                    <tr><th>DA Amount</th><td id="da_amount">0.00</td></tr>
                    <tr><th>HRA Amount</th><td id="hra_amount">0.00</td></tr>
                    <tr><th>PF Amount</th><td id="pf_amount">0.00</td></tr>
                    <tr><th>ESI Amount</th><td id="esi_amount">0.00</td></tr>
                    <tr><th>Gross Total</th><td id="gross_total">0.00</td></tr>
                    <tr><th>Unpaid Leaves</th><td>{{ summary.unpaid_days }}</td></tr>
                    <tr class="table-success">
                        <th>Net Salary</th><td id="net_salary">0.00</td>
                    </tr>
                </table>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const allowanceInput = document.getElementById('id_other_allowances');
    const daEl = document.getElementById('da_amount');
    const hraEl = document.getElementById('hra_amount');
    const pfEl = document.getElementById('pf_amount');
    const esiEl = document.getElementById('esi_amount');
    const grossEl = document.getElementById('gross_total');
    const netEl = document.getElementById('net_salary');

    const basic = parseFloat("{{ employee.salary }}");
    const bonus = parseFloat("{{ performance_bonus|default:0 }}");
    const unpaidDays = parseFloat("{{ summary.unpaid_days }}");
    const totalDays = 30;

    const daPercent = parseFloat("{{ common_pay.da }}");
    const hraPercent = parseFloat("{{ common_pay.hra }}");
    const pfPercent = parseFloat("{{ common_pay.pf }}");
    const esiPercent = parseFloat("{{ common_pay.esi }}");

    function calculatePayroll() {
        const allowance = parseFloat(allowanceInput.value) || 0;

        const daAmount = basic * daPercent / 100;
        const hraAmount = basic * hraPercent / 100;
        const pfAmount = basic * pfPercent / 100;
        const grossTotal = basic + daAmount + hraAmount + allowance + bonus;
        const esiAmount = (grossTotal <= 21000) ? grossTotal * esiPercent / 100 : 0;

        const perDaySalary = basic / totalDays;
        const leaveDeduction = perDaySalary * unpaidDays;
        const netSalary = grossTotal - pfAmount - esiAmount - leaveDeduction;

        daEl.textContent = daAmount.toFixed(2);
        hraEl.textContent = hraAmount.toFixed(2);
        pfEl.textContent = pfAmount.toFixed(2);
        esiEl.textContent = esiAmount.toFixed(2);
        grossEl.textContent = grossTotal.toFixed(2);
        netEl.textContent = netSalary.toFixed(2);
    }

    allowanceInput.addEventListener('input', calculatePayroll);
    calculatePayroll();
});
</script>
{% endblock %}


